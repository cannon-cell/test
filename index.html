<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub • Free movie</title>
  <style>
    :root{--bg:#0b0d10;--card:#151922;--text:#e3e7ee;--muted:#a1a9b8;--brand:#4f7cff;--border:#232a37}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    a{color:var(--text);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(11,13,16,.8);backdrop-filter:blur(6px);z-index:10}
    .nav{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .brand{font-weight:800}
    .nav input[type=search]{flex:1;background:#0e1218;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:12px}
    .menu a,.menu button{padding:8px 10px;color:var(--muted);background:none;border:none;cursor:pointer}
    .btn{background:var(--brand);color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer}
    .btn.secondary{background:#2a3446}
    .badge{font-size:12px;color:#fff;background:#2a3446;padding:2px 8px;border-radius:999px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card.clickable{cursor:pointer}
    .card.p{padding:12px;height:94px}
    .card img{width:100%;height:200px;object-fit:cover;display:block}
    .small{font-size:12px;color:var(--muted)}
    .alert{background:#152031;padding:10px;border-radius:10px;color:#b7c4e6;margin:8px 0}
    .flex{display:flex;gap:12px;align-items:center}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mt-2{margin-top:8px}.mt-4{margin-top:16px}.mt-8{margin-top:32px}
    textarea,input,select{width:100%;padding:10px;background:#0e1218;border:1px solid var(--border);color:#fff;border-radius:10px}
    footer{color:var(--muted);text-align:center;padding:30px 0}
    .hidden{display:none}
    /* video */
    .video-container{position:relative;width:100%;padding-bottom:56.25%;height:0;overflow:hidden;background:black;border-radius:22px}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}
  </style>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">🎬 StreamingHub</a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1">
      <input type="search" name="q" placeholder="Szukaj filmów…" />
    </form>
    <nav class="menu flex">
      <a id="filmLink" href="#" onclick="UI.show('home')">Filmy</a>
      <a href="#" onclick="UI.show('top')">TOP</a>
      <a href="#" onclick="UI.show('me')">Moja biblioteka</a>
      <a id="adminLink" href="#" onclick="UI.show('admin')" class="hidden">Admin</a>
      <span id="authLinks">
        <a href="#" onclick="UI.show('login')">Zaloguj</a>
        <a href="#" onclick="UI.show('register')" class="btn">Rejestracja</a>
      </span>
      <form id="logoutForm" class="hidden" onsubmit="event.preventDefault(); Auth.logout()">
        <button class="btn secondary">Wyloguj</button>
      </form>
    </nav>
  </div>
</header>

<main class="container" id="app"></main>

<footer>© <script>document.write(new Date().getFullYear())</script> StreamingHub • free video</footer>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   KONFIG: PODMIEŃ NA SWOJE
   ========================= */
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   UTILS
   ========================= */
const delay = (ms)=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s])); }
function toast(msg){ const d=document.createElement("div"); d.className="alert"; d.textContent=msg; d.style.position="fixed"; d.style.right="16px"; d.style.bottom="16px"; d.style.zIndex=9999; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); }

/* =========================
   AUTH + PROFILES
   ========================= */
const Auth = {
  async currentUser(){ const { data:{ user } } = await db.auth.getUser(); return user||null; },
  async currentProfile(){
    const user = await Auth.currentUser(); if(!user) return null;
    const { data, error } = await db.from("profiles").select("*").eq("id", user.id).maybeSingle();
    if(error){ console.error(error); return null; }
    return data ? { ...user, ...data } : { ...user };
  },
  async register(username, email, password){
    const { data, error } = await db.auth.signUp({ email, password });
    if(error) return alert("❌ " + error.message);
    const user = data.user;
    // profil może już być tworzony triggerem; mimo to upsert bezpieczny
    const { error: pErr } = await db.from("profiles").upsert({
      id: user.id, username, points: 0, is_admin: false
    });
    if(pErr) console.warn("Profil:", pErr.message);
    toast("✔️ Konto utworzone. Sprawdź e-mail (jeśli wymagane).");
    UI.show("home");
  },
  async login(email, password){
    const { error } = await db.auth.signInWithPassword({ email, password });
    if(error) return alert("❌ " + error.message);
    await UI.updateHeader();
    toast("✔️ Zalogowano");
    UI.show("home");
  },
  async logout(){ await db.auth.signOut(); await UI.updateHeader(); toast("Wylogowano"); UI.show("home"); }
};

// reaguj na zmianę sesji
db.auth.onAuthStateChange(async ()=>{ UI.updateHeader(); });

/* =========================
   DATA ACCESS (Supabase)
   ========================= */
// Movies
async function getMovies(filters={}){
  let q = db.from("movies").select("*");
  if(filters.q) q = q.ilike("title", `%${filters.q}%`);
  if(filters.category_id) q = q.eq("category_id", filters.category_id);
  if(filters.year) q = q.eq("year", filters.year);
  if(filters.min_duration) q = q.gte("duration", filters.min_duration);
  // sort
  if(filters.sort === "new") q = q.order("created_at", { ascending: false });
  else q = q.order("created_at", { ascending: false });
  const { data, error } = await q;
  if(error) throw error;
  return data||[];
}
async function getMovie(id){
  const { data, error } = await db.from("movies").select("*").eq("id", id).single();
  if(error) throw error; return data;
}
async function addMovie(payload){ return db.from("movies").insert(payload); }
async function deleteMovie(id){ return db.from("movies").delete().eq("id", id); }

// Categories
async function getCategories(){
  const { data, error } = await db.from("categories").select("*").order("name");
  if(error) throw error; return data||[];
}
async function addCategory(name){ return db.from("categories").insert({ name }); }
async function delCategory(id){ return db.from("categories").delete().eq("id", id); }

// Ratings
async function getRatingsFor(movieId){
  const { data, error } = await db.from("ratings").select("score").eq("movie_id", movieId);
  if(error) throw error; return data||[];
}
async function upsertRating(movieId, userId, score){
  return db.from("ratings").upsert({ movie_id: movieId, user_id: userId, score });
}
async function getUserRating(movieId, userId){
  const { data, error } = await db.from("ratings").select("*").eq("movie_id", movieId).eq("user_id", userId).maybeSingle();
  if(error) throw error; return data||null;
}

// Comments
async function getComments(movieId){
  // pobierz komentarze + nazwę autora z profiles
  const { data, error } = await db
    .from("comments")
    .select("id,text,created_at,user_id,profiles(username)")
    .eq("movie_id", movieId)
    .order("created_at", { ascending:false });
  if(error) throw error; return data||[];
}
async function addComment(movieId, userId, text){
  return db.from("comments").insert({ movie_id: movieId, user_id: userId, text });
}

// Wishlist
async function getWishlist(userId){
  const { data, error } = await db.from("wishlist").select("movie_id").eq("user_id", userId);
  if(error) throw error; return new Set((data||[]).map(x=>x.movie_id));
}
async function toggleWishlist(userId, movieId){
  const { data, error } = await db.from("wishlist").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") console.warn(error);
  if(data){
    return db.from("wishlist").delete().eq("id", data.id);
  } else {
    return db.from("wishlist").insert({ user_id:userId, movie_id:movieId });
  }
}

// Watch history
async function addWatch(userId, movieId){
  return db.from("watch_history").insert({ user_id: userId, movie_id: movieId, watched_at: new Date().toISOString() });
}
async function getWatchHistory(userId, limit=100){
  const { data, error } = await db
    .from("watch_history")
    .select("movie_id, watched_at, movies(title,thumb,id)")
    .eq("user_id", userId)
    .order("watched_at", { ascending:false })
    .limit(limit);
  if(error) throw error; return data||[];
}

// Points & unlocks
async function addPoints(userId, change, reason){
  // 1) log
  const { error: logErr } = await db.from("points_log").insert({ user_id:userId, change, reason });
  if(logErr) throw logErr;
  // 2) update profiles.points (race-safe-ish: re-read then set)
  const { data: prof } = await db.from("profiles").select("points").eq("id", userId).single();
  const next = (prof?.points||0) + change;
  const { error: upErr } = await db.from("profiles").update({ points: next }).eq("id", userId);
  if(upErr) throw upErr;
}
async function getPoints(userId){
  const { data, error } = await db.from("profiles").select("points").eq("id", userId).single();
  if(error) throw error; return data?.points||0;
}
async function ensureUnlocked(userId, movieId){
  const { data, error } = await db.from("unlocks").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") throw error;
  if(!data){ const { error: insErr } = await db.from("unlocks").insert({ user_id:userId, movie_id:movieId }); if(insErr) throw insErr; }
}
async function isUnlocked(userId, movieId){
  const { data, error } = await db.from("unlocks").select("id").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") throw error;
  return !!data;
}

// Codes
async function redeemCode(userId, codeStr){
  const code = (codeStr||"").trim();
  if(!code) return { ok:false, msg:"Podaj kod" };
  const { data, error } = await db.from("codes").select("*").eq("code", code).maybeSingle();
  if(error) return { ok:false, msg:error.message };
  if(!data) return { ok:false, msg:"Nieprawidłowy kod" };
  if((data.limit_left||0) <= 0) return { ok:false, msg:"Wyczerpany limit użyć" };
  if(data.expires && new Date(data.expires) < new Date()) return { ok:false, msg:"Kod wygasł" };

  if(data.type === "points"){
    await addPoints(userId, data.amount, `Kod: ${data.code}`);
  } else if(data.type === "premium"){
    // wymaga kolumny premium_until w profiles
    const { data: prof } = await db.from("profiles").select("premium_until").eq("id", userId).maybeSingle();
    if(!prof || typeof prof.premium_until === "undefined"){
      return { ok:false, msg:"Brak pola premium w profiles (premium_until)" };
    }
    const days = Number(data.days||data.amount||7);
    const base = prof.premium_until ? new Date(prof.premium_until) : new Date();
    const start = (prof.premium_until && new Date(prof.premium_until) > new Date()) ? new Date(prof.premium_until) : new Date();
    const until = new Date(start.getTime() + days*24*60*60*1000);
    const { error: upErr } = await db.from("profiles").update({ premium_until: until.toISOString() }).eq("id", userId);
    if(upErr) return { ok:false, msg: upErr.message };
  }
  // zmniejsz limit
  await db.from("codes").update({ limit_left: (data.limit_left||0) - 1 }).eq("id", data.id);
  return { ok:true, msg:"Kod zrealizowany ✔️" };
}

// Leaderboard (last N days)
async function leaderboard(days){
  const since = new Date(Date.now() - days*24*60*60*1000).toISOString();
  const { data, error } = await db.from("points_log").select("user_id, change, created_at").gte("created_at", since);
  if(error) throw error;
  const map = new Map();
  (data||[]).forEach(r=>{ if(r.change>0) map.set(r.user_id, (map.get(r.user_id)||0) + r.change); });
  const entries = [...map.entries()].map(([user_id, gained])=>({ user_id, gained }));
  entries.sort((a,b)=>b.gained-a.gained);
  const top = entries.slice(0,100);
  // dołącz nicki
  if(top.length){
    const ids = top.map(t=>t.user_id);
    const { data: profs } = await db.from("profiles").select("id,username").in("id", ids);
    const nameById = new Map((profs||[]).map(p=>[p.id,p.username]));
    top.forEach(t=> t.username = nameById.get(t.user_id)||"Użytkownik");
  }
  return top.map((t,i)=>({ rank:i+1, user:t.username, gained:t.gained }));
}

/* =========================
   UI
   ========================= */
const UI = {
  el: ()=>document.getElementById("app"),
  async updateHeader(){
    const u = await Auth.currentProfile();
    document.getElementById("adminLink").classList.toggle("hidden", !(u&&u.is_admin));
    document.getElementById("logoutForm").classList.toggle("hidden", !u);
    document.getElementById("authLinks").classList.toggle("hidden", !!u);
      // podmień przycisk "Filmy" w zależności od logowania
  const filmLink = document.getElementById("filmLink");
  if (u) {
    filmLink.setAttribute("href", "filmy.html");
    filmLink.removeAttribute("onclick");
  } else {
    filmLink.setAttribute("href", "#");
    filmLink.setAttribute("onclick", "UI.show('home')");
  }

  },
  async show(view, params={}){
